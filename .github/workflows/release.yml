name: Publish and release CumulusCI ğŸš€

on:
    push:
        branches:
            - main
        paths:
            - cumulusci/__about__.py

concurrency: publishing

jobs:
    publish-to-pypi:
        name: Publish new release to PyPI ğŸ“¦
        runs-on: SFDO-Tooling-Ubuntu
        steps:
            - uses: actions/checkout@main
            - name: Set up Python 3.8 ğŸ
              uses: actions/setup-python@v4
              with:
                  python-version: 3.8
                  cache: pip
            - name: Install build tools ğŸ› ï¸
              run: python -m pip install hatch tomli tomli-w
            - name: Pin dependencies ğŸ“Œ
              run: python utility/pin_dependencies.py
            - name: Build source tarball and binary wheel ğŸ“¦
              run: hatch build -c
            - name: Convert cumulusci.yml to cumulusci.json ğŸ”„
              run: python -c "import yaml, json; json.dump(yaml.safe_load(open('cumulusci/cumulusci.yml')), open('cumulusci/cumulusci.json', 'w'))"
            - name: Upload to PyPI ğŸš€
              run: hatch publish
              env:
                  HATCH_INDEX_USER: "__token__"
                  HATCH_INDEX_AUTH: ${{ secrets.PYPI_TOKEN }}
            - name: Create release ğŸ“
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  VERSION="$(hatch version)"
                  awk '/<!-- latest-start -->/,/<!-- latest-stop -->/' docs/history.md > changelog.md
                  gh release create "v$VERSION" \
                    dist/*.whl \
                    dist/*.tar.gz \
                    cumulusci/cumulusci.yml \
                    cumulusci/cumulusci.json \
                    cumulusci/schema/cumulusci.jsonschema.json \
                    --notes-file changelog.md \
                    --title $VERSION
