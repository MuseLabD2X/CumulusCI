name: Publish and Release CumulusCI ğŸ“¦âœ¨

on:
    push:
        branches:
            - main
        paths:
            - cumulusci/__about__.py

concurrency: publishing

jobs:
    publish-to-pypi:
        name: ğŸš€ Publish to PyPI
        runs-on: ${{ github.repository_owner == 'SFDO-Tooling' && 'SFDO-Tooling-Ubuntu' || 'ubuntu-latest' }}
        steps:
            - name: ğŸ“¦ Checkout Code
              uses: actions/checkout@main
            - name: ğŸ Set up Python 3.8
              uses: actions/setup-python@v4
              with:
                  python-version: 3.8
                  cache: pip
            - name: ğŸ› ï¸ Install build tools
              run: |
                  echo "Installing build tools..."
                  python -m pip install hatch tomli tomli-w
            - name: ğŸ“Œ Pin dependencies
              run: |
                  echo "Pinning dependencies..."
                  python utility/pin_dependencies.py
            - name: ğŸ—ï¸ Build source tarball and binary wheel
              run: |
                  echo "Building packages..."
                  hatch build -c
            - name: ğŸ“¤ Upload to PyPI
              run: |
                  echo "Uploading to PyPI..."
                  hatch publish
              env:
                  HATCH_INDEX_USER: "__token__"
                  HATCH_INDEX_AUTH: ${{ secrets.PYPI_TOKEN }}
            - name: ğŸ“ Create release
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "Creating GitHub release..."
                  VERSION="$(hatch version)"
                  awk '/<!-- latest-start -->/,/<!-- latest-stop -->/' docs/history.md > changelog.md
                  gh release create "v$VERSION" \
                    dist/*.whl \
                    dist/*.tar.gz \
                    --notes-file changelog.md \
                    --title $VERSION
            - name: ğŸ“„ Generate cumulusci.yml with version suffix
              run: |
                  echo "Generating cumulusci.yml with version suffix..."
                  VERSION="$(hatch version)"
                  cp cumulusci/cumulusci.yml cumulusci/cumulusci-${VERSION}.yml
            - name: ğŸ”„ Convert yml to json without indent
              run: |
                  echo "Converting YAML to JSON..."
                  VERSION="$(hatch version)"
                  yq eval -o=json cumulusci/cumulusci-${VERSION}.yml > cumulusci/cumulusci-${VERSION}.json
            - name: ğŸ› ï¸ Generate JSON schema
              run: |
                  echo "Generating JSON schema..."
                  VERSION="$(hatch version)"
                  cp cumulusci/schema/schema.json cumulusci/schema/schema-${VERSION}.json
            - name: ğŸ“¤ Upload release artifacts
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: cumulusci/cumulusci-${VERSION}.yml
                  asset_name: cumulusci-${VERSION}.yml
                  asset_content_type: application/x-yaml
            - name: ğŸ“¤ Upload JSON artifact
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: cumulusci/cumulusci-${VERSION}.json
                  asset_name: cumulusci-${VERSION}.json
                  asset_content_type: application/json
            - name: ğŸ“¤ Upload JSON schema
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: cumulusci/schema/schema-${VERSION}.json
                  asset_name: schema-${VERSION}.json
                  asset_content_type: application/json
