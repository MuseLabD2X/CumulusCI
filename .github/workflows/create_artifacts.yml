name: Create Artifacts üõ†Ô∏èüì¶

on:
    workflow_call:
        inputs:
            python-version:
                required: true
                type: string
        secrets:
            PYPI_TOKEN:
                required: true
            GITHUB_TOKEN:
                required: true

jobs:
    build_artifacts:
        name: üèóÔ∏è Build Artifacts
        runs-on: ubuntu-latest
        steps:
            - name: üì¶ Checkout Code
              uses: actions/checkout@v3

            - name: üêç Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ inputs.python-version }}
                  cache: pip

            - name: üõ†Ô∏è Install Build Tools
              run: |
                  echo "Installing build tools..."
                  python -m pip install hatch tomli tomli-w

            - name: üìå Pin Dependencies
              run: |
                  echo "Pinning dependencies..."
                  python utility/pin_dependencies.py

            - name: üèóÔ∏è Build Source Tarball and Binary Wheel
              run: |
                  echo "Building packages..."
                  hatch build -c

            - name: üìÑ Generate cumulusci.yml with Version Suffix
              run: |
                  echo "Generating cumulusci.yml with version suffix..."
                  VERSION="$(hatch version)"
                  cp cumulusci/cumulusci.yml cumulusci/cumulusci-${VERSION}.yml

            - name: üîÑ Convert YAML to JSON Without Indent
              run: |
                  echo "Converting YAML to JSON..."
                  VERSION="$(hatch version)"
                  yq eval -o=json cumulusci/cumulusci-${VERSION}.yml > cumulusci/cumulusci-${VERSION}.json

            - name: üõ†Ô∏è Generate JSON Schema
              run: |
                  echo "Generating JSON schema..."
                  VERSION="$(hatch version)"
                  cp cumulusci/schema/schema.json cumulusci/schema/schema-${VERSION}.json

            - name: üì§ Upload Artifacts to Job Outputs
              uses: actions/upload-artifact@v3
              with:
                  name: build-artifacts
                  path: |
                      cumulusci/cumulusci-*.yml
                      cumulusci/cumulusci-*.json
                      cumulusci/schema/schema-*.json
