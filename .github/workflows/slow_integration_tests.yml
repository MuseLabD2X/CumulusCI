name: Integration Tests üß™

on:
    pull_request_review:
        types: [submitted]

    workflow_call:
        secrets:
            CUMULUSCI_SERVICE_github:
                required: true
            CCITEST_APP_KEY:
                required: true

    workflow_dispatch:

env:
    CUMULUSCI_KEY: ${{ secrets.CUMULUSCI_KEY }}
    CUMULUSCI_SERVICE_github: ${{ secrets.CUMULUSCI_SERVICE_github }}
    GITHUB_APP_ID: 129383
    GITHUB_APP_KEY: ${{ secrets.CCITEST_APP_KEY }}

jobs:
    org_backed_tests:
        name: üè¢ Org-connected Tests
        runs-on: ${{ github.repository_owner == 'SFDO-Tooling' && 'SFDO-Tooling-Ubuntu' || 'ubuntu-latest' }}
        steps:
            - name: üì¶ Checkout Code
              uses: actions/checkout@v2
            - name: üêç Set up Python 3.8
              uses: actions/setup-python@v4
              with:
                  python-version: 3.8
                  cache: pip
                  cache-dependency-path: "requirements/*.txt"
            - name: üì• Install Python dependencies
              run: |
                  echo "Installing dependencies..."
                  python -m pip install -U pip
                  pip install -r requirements_dev.txt
            - name: ‚öôÔ∏è Install sfdx
              run: |
                  echo "Installing Salesforce CLI..."
                  mkdir sfdx
                  wget -qO- https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz | tar xJ -C sfdx --strip-components 1
                  echo $(realpath sfdx/bin) >> $GITHUB_PATH
            - name: üîê Authenticate Dev Hub
              run: |
                  echo "Authenticating Dev Hub..."
                  sfdx plugins --core
                  echo $SFDX_HUB_KEY_BASE64 | base64 --decode > sfdx.key
                  sfdx auth:jwt:grant --clientid $SFDX_CLIENT_ID --jwtkeyfile sfdx.key --username $SFDX_HUB_USERNAME --setdefaultdevhubusername -a hub
              env:
                  SFDX_HUB_KEY_BASE64: ${{ secrets.SFDX_HUB_KEY_BASE64 }}
                  SFDX_CLIENT_ID: ${{ secrets.SFDX_CLIENT_ID }}
                  SFDX_HUB_USERNAME: ${{ secrets.SFDX_HUB_USERNAME }}
            - name: üìº Re-make VCR tapes (transiently)
              run: make vcr
            - name: üßπ Delete scratch org
              if: always()
              run: |
                  echo "Deleting scratch org..."
                  cci org scratch_delete pytest
    robot_ui:
        name: ü§ñ Robot Tests: ${{ matrix.job-name }}
        runs-on: ${{ github.repository_owner == 'SFDO-Tooling' && 'SFDO-Tooling-Ubuntu' || 'ubuntu-latest' }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - browser: "BROWSER:headlesschrome"
                      job-name: "Chrome"
                      org-shape: "dev"
                    # - browser: "BROWSER:headlessfirefox"
                    #   job-name: "Firefox"
                    #   org-shape: "dev"
                    # - browser: "BROWSER:headlesschrome"
                    #   job-name: "Pre-release"
                    #   org-shape: "prerelease"
        steps:
            - name: üì¶ Checkout Code
              uses: actions/checkout@v2
            - name: üêç Set up Python 3.8
              uses: actions/setup-python@v4
              with:
                  python-version: 3.8
                  cache: pip
                  cache-dependency-path: "requirements/*.txt"
            - name: üì• Install Python dependencies
              run: |
                  echo "Installing dependencies..."
                  pip install -r requirements_dev.txt
            - name: ‚öôÔ∏è Install sfdx
              run: |
                  echo "Installing Salesforce CLI..."
                  mkdir sfdx
                  wget -qO- https://developer.salesforce.com/media/salesforce-cli/sf-linux-x64.tar.xz | tar xJ -C sfdx --strip-components 1
                  echo $(realpath sfdx/bin) >> $GITHUB_PATH
            - name: üñ•Ô∏è Initialize Browser/Playwright
              run: |
                  echo "Initializing Playwright..."
                  cci robot install_playwright
            - name: üîê Authenticate Dev Hub
              run: |
                  echo "Authenticating Dev Hub..."
                  sfdx plugins --core
                  echo $SFDX_HUB_KEY_BASE64 | base64 --decode > sfdx.key
                  sf org login jwt --client-id $SFDX_CLIENT_ID --jwt-key-file sfdx.key --username $SFDX_HUB_USERNAME --setdefaultdevhubusername -a hub
              env:
                  SFDX_HUB_KEY_BASE64: ${{ secrets.SFDX_HUB_KEY_BASE64 }}
                  SFDX_CLIENT_ID: ${{ secrets.SFDX_CLIENT_ID }}
                  SFDX_HUB_USERNAME: ${{ secrets.SFDX_HUB_USERNAME }}
            - name: üèÉ Run robot tests
              run: |
                  echo "Running robot tests..."
                  coverage run --append $(which cci) task run robot \
                    --org ${{ matrix.org-shape }} \
                    -o suites cumulusci/robotframework/tests/salesforce \
                    -o exclude no-browser \
                    -o vars ${{ matrix.browser }}
            - name: üßπ Delete scratch org
              if: always()
              run: |
                  echo "Deleting scratch org..."
                  cci org scratch_delete ${{ matrix.org-shape }}
            - name: üì§ Store robot results
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: robot
                  path: robot/CumulusCI/results
